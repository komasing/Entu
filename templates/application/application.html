{% extends main_template %}

{% block content %}
<div id="wide_content">

    {% for l in languages %}
    <a href="?language={{ l.value }}" style="float:right;">{{ l.label }}</a><br />
    {% endfor %}

    {% if system_logo %}
    <img src="{{ system_logo }}" alt="logo" style="margin:0px auto 50px auto; display:block;" />
    {% endif %}

    <h1>{{ str.application }}</h1>
    <div style="display:block; margin:20px; text-align:center;">{{ str.application_info }}</div>

    <section class="table" style="margin:0px; width:100%;">
            <div class="row">
                <div class="cell" style="width:300px; padding:0px; border-right:none; border-top:none;">
                    <h2>{{ receptions_label }}</h2>
                </div>
                <div class="cell" style="padding:0px; border-top:none;">
                </div>
            </div>
        {% for r in receptions %}
            <div class="row">
                <div class="v_header" style="{% if not r.group %} border-top:none;{% endif %}{% if not r.is_open %}font-style:italic;{% endif %}width:300px;">
                    {{ r.group|default:"" }}
                </div>
                <div class="cell" style="width:590px;padding-right:10px;{% if not r.is_open %}font-style:italic;{% endif %}">
                    {% if r.url %}
                    <a href="{{ r.url }}" target="_blank">{{ r.displayname }}</a>
                    {% else %}
                    {{ r.displayname }}
                    {% endif %}
                    {% if r.is_open %}
                        <a href="javascript:void(0);" class="check" style="float:right; {% if r.is_selected %}color:#008000; font-weight:bold;{% else %}color:#222222;{% endif %}" data-bubble="{{ r.key }}" data-value="{{ r.is_selected }}">{{ str.application_apply }}</a>
                    {% else %}
                        <span style="float:right; {% if r.is_selected %}color:#008000; font-weight:bold;{% else %}color:#222222;{% endif %}">{{ str.application_apply }}</span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
            <div class="row">
                <div class="cell" style="width:300px; padding:0px; border-right:none;">
                    <h2>{{ bubble_label }}</h2>
                </div>
                <div class="cell" style="padding:0px;">
                </div>
            </div>
        {% for t in bubble %}
            {% if t.data_property != "x_type" and t.data_property != "confirmed" and t.data_property != "has_been_subsidised" %}
                {% for v in t.values %}
                <div class="row">
                    <div class="v_header" style="width:300px;{% if t.is_mandatory %} color:red;{% endif %} white-space:normal;">
                        {{ t.name }}
                    </div>
                    {% if t.is_read_only %}
                        <div class="cell" style="width:590px">
                            {{ v.value|default:"" }}
                        </div>
                    {% else %}

                        {% if t.data_type == "string" or t.data_type == "integer" or t.data_type == "float" or t.data_type == "date" or t.data_type == "datetime" %}
                            <input type="text" name="{{ t.key }}" data-oldvalue="{{ v.value|default:"" }}" class="cell autosave dtype_{{ t.data_type }}{% if t.is_mandatory %} mandatory{% endif %}" value="{{ v.value|default:"" }}" style="width:590px" />
                        {% endif %}

                        {% if t.data_type == "text" %}
                            <textarea type="text" name="{{ t.key }}" data-oldvalue="{{ v.value|default:"" }}" class="cell autosave dtype_{{ t.data_type }}{% if t.is_mandatory %} mandatory{% endif %}" style="width:590px">{{ v.value|default:"" }}</textarea>
                        {% endif %}

                        {% if t.data_type == "boolean" %}
                            <div class="cell" style="width:590px; vertical-align:middle;">
                                <input type="checkbox" name="{{ t.key }}" data-oldvalue="{{ v.value|default:"" }}" class="autosave dtype_{{ t.data_type }}"{% if v.value|default:"" %} checked{% endif %} />
                            </div>
                        {% endif %}

                        {% if t.data_type == "blobstore" %}
                            <div class="cell" style="width:590px" id="{{ t.data_type }}_{{ bubble_key }}_{{ t.key }}">
                                {% if v.image_url %}<img src="{{ v.image_url }}=s100-c" style="padding-bottom:5px;" />{% endif %}
                                <iframe name="iframe_{{ t.key }}" height="0" width="0" frameborder="0" scrolling="no" onLoad="showImage(this.contentWindow.document.body.innerHTML, 'blobstore_{{ bubble_key }}_{{ t.key }}');" style="display:none;"></iframe>
                                <form method="post" action="{{ blobstore_upload_url }}" target="iframe_{{ t.key }}" enctype="multipart/form-data">
                                    <input type="file" name="file" class="dtype_{{ t.data_type }}" style="border:none; width:82px;" />
                                    <input type="hidden" name="type" value="{{ t.data_type }}" />
                                    <input type="hidden" name="bubble" value="{{ bubble_key }}" />
                                    <input type="hidden" name="property" value="{{ t.key }}" />
                                </form>
                            </div>
                        {% endif %}

                        {% if t.choices %}
                            <div class="cell" style="width:590px">
                                <select name="{{ t.key }}" data-oldvalue="{{ v.key }}" class="autosave choices dtype_{{ t.data_type }}{% if t.is_mandatory %} mandatory{% endif %}" data-placeholder="{{ v.value|default:"" }}">
                                    <option value=""></option>
                                </select>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            {% endif %}
        {% endfor %}
    </section>

    {% for sb in subbubbles %}
        <h2>{{ sb.label }}<span>{{ sb.info|default:""|safe }}</span></h2>
        <section class="table" style="margin:0px; width:100%;">
        {% for e in sb.bubbles %}
            {% if forloop.first %}
            <div class="row">
            {% for t in e.props %}
                <div class="h_header" style="{% if t.is_mandatory %}color:red;{% endif %}">
                    {{ t.name }}
                </div>
            {% endfor %}
            </div>
            {% endif %}

            <div class="row">
            {% for t in e.props %}
                {% for v in t.values %}
                    {% if t.is_read_only or t.is_create_only and v.value %}
                        <div class="cell">
                            {{ v.value|default:""|escape }}
                        </div>
                    {% else %}
                        {% if t.data_type == "string" or t.data_type == "integer" or t.data_type == "float" or t.data_type == "date" or t.data_type == "datetime" %}
                            <div class="cell" style="text-align:center; padding:0px;" id="{{ t.data_type }}_{{ e.key|default:"" }}_{{ t.key }}">
                                <input type="text" name="{{ t.key }}" data-type="{{ sb.type }}" data-bubble="{{ e.key|default:"" }}" data-oldvalue="{{ v.value|default:"" }}" class="autosave_subbubble dtype_{{ t.data_type }}" value="{{ v.value|default:"" }}" style="border:none; width:100%; padding: 5px 0px;" />
                            </div>
                        {% endif %}

                        {% if t.data_type == "text" %}
                            <div class="cell" style="text-align:center; padding:0px;" id="{{ t.data_type }}_{{ e.key|default:"" }}_{{ t.key }}">
                                <textarea type="text" name="{{ t.key }}" data-type="{{ sb.type }}" data-bubble="{{ e.key|default:"" }}" data-oldvalue="{{ v.value|default:"" }}" class="autosave_subbubble dtype_{{ t.data_type }}" style="border:none; width:100%; height:20px; padding: 5px 0px;" rows="1">{{ v.value|default:"" }}</textarea>
                            </div>
                        {% endif %}

                        {% if t.data_type == "boolean" %}
                            <div class="cell" style="text-align:center; vertical-align:middle; padding:0px;" id="{{ t.data_type }}_{{ e.key|default:"" }}_{{ t.key }}">
                                <input type="checkbox" name="{{ t.key }}" data-type="{{ sb.type }}" data-bubble="{{ e.key|default:"" }}" data-oldvalue="{{ v.value|default:"" }}" class="autosave_subbubble dtype_{{ t.data_type }}"{% if v.value|default:"" %} checked{% endif %} />
                            </div>
                        {% endif %}

                        {% if t.data_type == "blobstore" %}
                            {% if not v.value and forloop.first %}
                                <div class="cell" style="padding:5px;" id="{{ t.data_type }}_{{ e.key|default:"" }}_{{ t.key }}">
                                    <iframe name="iframe_{{ t.key }}" height="0" width="0" frameborder="0" scrolling="no" onLoad="showDocument(this.contentWindow.document.body.innerHTML, 'blobstore_{{ e.key|default:"" }}_{{ t.key }}');" style="display:none;"></iframe>
                                    <form method="post" action="{{ blobstore_upload_url }}" target="iframe_{{ t.key }}" enctype="multipart/form-data">
                                        <input type="file" name="file" class="dtype_{{ t.data_type }}" style="border:none; width:82px;" />
                                        <input type="hidden" name="type" value="{{ sb.type }}" />
                                        <input type="hidden" class="autosave_subbubble blobstore_bubble" name="bubble" value="{{ e.key|default:"" }}" />
                                        <input type="hidden" name="property" value="{{ t.key }}" />
                                    </form>
                                </div>
                            {% endif %}
                            {% if e.key and v.value %}
                                <div class="cell" style="padding:5px; vertical-align:middle;" id="{{ t.data_type }}_{{ e.key|default:"" }}_{{ t.key }}">
                                    <a href="/application/file/{{ t.data_property }}/{{ v.key }}">{{ v.value }}</a>
                                </div>
                            {% endif %}
                        {% endif %}

                        {% if t.choices %}
                            <div class="cell">
                                <select name="{{ t.key }}" data-type="{{ sb.type }}" data-bubble="{{ e.key|default:"" }}" data-oldvalue="{{ v.key }}" class="autosave_subbubble choices dtype_{{ t.data_type }}">
                                    <option value=""></option>
                                </select>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            </div>
        {% endfor %}
        </section>
    {% endfor %}
    <div style="display:block; color:green; font-weight:bold; margin:50px 0px;">
        <a href="/application/signin" class="button" style="float:right;">{{ str.application_logout }}</a>
        <a id="submit_application" href="javascript:void(0);" class="button">{{ str.application_submit }}</a>
    </div>
</section>

<script>

    function showDocument(json_string, div){
        var json = jQuery.parseJSON(json_string);
        $('#'+div).html(json['filename']);
        $('#'+div).parent().find('.autosave_subbubble').each(function() {
            if(!$(this).data('bubble')){
                $(this).data('bubble', json['bubble']);
            }
        });
    };

    function showImage(image, div){
        $('#'+div).append('<img src="'+image+'=s100-c" style="padding-bottom:5px;" />');
    };

    $(document).ready(function(){
        leeching_count = {{ leeching_count }};

        fillSelects();

        function sort_unique(arr) {
            arr = arr.sort(function (a, b) { return a*1 - b*1; });
            var ret = [arr[0]];
            for (var i = 1; i < arr.length; i++) { // start loop at 1 as element 0 can never be a duplicate
                if (arr[i-1] !== arr[i]) {
                    ret.push(arr[i]);
                }
            }
            return ret;
        };

        function fillSelects(){
            names = [];
            $('.choices').each(function() {
                names.push($(this).attr('name'));
            });
            names = sort_unique(names);
            for (n in names) {
                $.post('/application/sfv', { 'property': names[n] }, function(json) {
                    $('select[name='+json.property+']').each(function() {
                        selectbox = $(this);
                        for (i in json.values) {
                            item = json.values[i];
                            if(selectbox.data('oldvalue').indexOf(item.key) != -1) {
                                selected = ' selected';
                            } else {
                                selected = '';
                            }
                            selectbox.append('<option value="'+item.key+'"'+selected+'>'+item.value+'</option>');
                            selectbox.prev('img').hide();
                        };
                    });
                }, 'json');
            };

        };

        $('.check').click(function() {
            chkbox = $(this);
            if (chkbox.data('value') == 'False') {
                if(leeching_count < 4) {
                    leeching_count += 1;
                    chkbox.data('value', 'True');
                    chkbox.css('color', '#008000');
                    chkbox.css('font-weight', 'bold');
                    $.post('/application/leech', {bubble: chkbox.data('bubble'), action: 'add'});
                } else {
                    alert('{{ str.application_no_more_submissions }}');
                }
            } else {
                leeching_count -= 1;
                chkbox.data('value', 'False');
                chkbox.css('color', '#222222');
                chkbox.css('font-weight', 'normal');
                $.post('/application/leech', {bubble: chkbox.data('bubble'), action: 'remove'});
            }
        });

        $('textarea').elastic();

        $('.dtype_blobstore').change(function() {
            $(this).parent().hide();
            $(this).parent().parent().append('<img src="/images/spinner_white.gif"/>')
            $(this).parent().submit();
        });

        $('.dtype_datetime').change(function() {
            $(this).val(format_date($(this).val(), 'dd.MM.yyyy HH:mm'));
        });

        $('.dtype_date').change(function() {
            $(this).val(format_date($(this).val(), 'dd.MM.yyyy'));
        });

        function format_date(dinput, format) {
            result = ''
            dvalue = Date.parse(dinput);
            if(dvalue) {
                result = dvalue.toString(format);
            }
            return result;
        }

        $('.autosave').change(function() {
            inputbox = $(this);
            if (inputbox.attr('type') == 'checkbox') {
                value = inputbox.is(':checked');
            } else {
                value = inputbox.val();
            }
            if (value != inputbox.data('oldvalue')) {
                $.post('/application', {property: inputbox.attr('name'), oldvalue: inputbox.data('oldvalue'), newvalue: value}, function(newvalue) {
                    inputbox.data('oldvalue', newvalue);
                });
            }
        });

        $('.autosave_subbubble').change(function() {
            inputbox = $(this);
            if (inputbox.attr('type') == 'checkbox') {
                value = inputbox.is(':checked');
            } else {
                value = inputbox.val();
            }
            if (value != inputbox.data('oldvalue')) {
                $.post('/application/subbubble', {bubble: inputbox.data('bubble'), type: inputbox.data('type'), property: inputbox.attr('name'), oldvalue: inputbox.data('oldvalue'), newvalue: value}, function(json) {
                    inputbox.data('oldvalue', json['value']);
                    if (!inputbox.data('bubble')) {
                        var newrow = inputbox.parent().parent().clone(true);
                        newrow.find('.autosave_subbubble').val('')
                        inputbox.parent().parent().find('.autosave_subbubble').each(function() {
                            if($(this).hasClass('blobstore_bubble')) {
                                $(this).val(json['bubble']);
                            }
                            if(!$(this).data('bubble')){
                                $(this).data('bubble', json['bubble']);
                            }
                        });
                        inputbox.parent().parent().after(newrow);
                    }
                }, 'json');
            }
        });

        $('#submit_application').click(function() {
            apply_ok = false;
            mandatory_ok = true;
            $('.check').each(function() {
                if($(this).data('value') == 'True') {
                    apply_ok = true;
                }
            });
            $('.mandatory').each(function() {
                if(!$(this).val()) {
                    mandatory_ok = false;
                }
            });

            if(apply_ok == true && mandatory_ok == true) {
                $(this).replaceWith('{{ str.application_submit_success_message }}');
                $.post('/application/submit');
            } else if (apply_ok == false) {
                alert('{{ str.application_missing_apply }}');
                scroll(0,0);
            } else {
                alert('{{ str.application_missing_mandatory_fields }}');
            }
        });

   });
</script>
{% endblock %}
